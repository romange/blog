<!doctype html><html lang=en-us><head><title>Introduction to fibers in c++ &#183; These are the wrong sort of bees</title><meta name=generator content="Hugo 0.104.3"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=author content="Roman Gershman"><meta name=description content="A small introduction to fiber-based programming model based on Boost.Fibers library"><link rel=canonical href=https://romange.github.io/blog/preview/2018/12/15/introduction-to-fibers-in-c-/><link rel=icon href=https://romange.github.io/blog/preview/favicon.ico><link rel=apple-touch-icon href=https://romange.github.io/blog/preview/apple-touch-icon.png><link rel=stylesheet href=https://romange.github.io/blog/preview/css/style.css><link rel=stylesheet href=https://romange.github.io/blog/preview/css/font-awesome.min.css><link rel=stylesheet href=https://romange.github.io/blog/preview/css/monokai.css><link rel=stylesheet href=https://romange.github.io/blog/preview/fancybox/jquery.fancybox.css><link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel=stylesheet type=text/css><link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel=stylesheet type=text/css><meta property="og:title" content="Introduction to fibers in c++"><meta property="og:description" content="A small introduction to fiber-based programming model based on Boost.Fibers library"><meta property="og:type" content="article"><meta property="og:url" content="https://romange.github.io/blog/preview/2018/12/15/introduction-to-fibers-in-c-/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-12-15T11:59:52+03:00"><meta property="article:modified_time" content="2018-12-15T11:59:52+03:00"><meta itemprop=name content="Introduction to fibers in c++"><meta itemprop=description content="A small introduction to fiber-based programming model based on Boost.Fibers library"><meta itemprop=datePublished content="2018-12-15T11:59:52+03:00"><meta itemprop=dateModified content="2018-12-15T11:59:52+03:00"><meta itemprop=wordCount content="1369"><meta itemprop=keywords content="c++,asynchronous,fibers,reactive,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Introduction to fibers in c++"><meta name=twitter:description content="A small introduction to fiber-based programming model based on Boost.Fibers library"><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js></script></head><body><div class=container><div id=container><header id=header><div id=header-main class=header-inner><div class=outer><a href=https://romange.github.io/blog/preview/ id=logo><i class=logo style=background-image:url(https://romange.github.io/blog/preview/css/images/7.png)></i>
<span class=site-title>These are the wrong sort of bees</span></a><nav id=main-nav><a class=main-nav-link href=https://romange.github.io/blog/preview/tags/>Tags</a>
<a class=main-nav-link href=https://romange.github.io/blog/preview/about/>About</a></nav><nav id=sub-nav><div class=profile id=profile-nav><a id=profile-anchor href=javascript:;><img class=avatar src=https://romange.github.io/blog/preview/css/images/avatar.png><i class="fa fa-caret-down"></i></a></div></nav><div id=search-form-wrap><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder=Search>
<button type=submit class=search-form-submit></button>
<input type=hidden name=sitesearch value=https://romange.github.io/blog/preview/></form></div></div></div><div id=main-nav-mobile class="header-sub header-inner"><table class="menu outer"><tbody><tr><td><a class=main-nav-link href=https://romange.github.io/blog/preview/tags/>Tags</a></td><td><a class=main-nav-link href=https://romange.github.io/blog/preview/about/>About</a></td><td><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder=Search>
<input type=hidden name=sitesearch value=https://romange.github.io/blog/preview/></form></td></tr></tbody></table></div></header><div class=outer><aside id=profile><div class="inner profile-inner"><div class="base-info profile-block"><img id=avatar src="https://www.gravatar.com/avatar/4a203a48eb1cdb1b8c47d008f0c139c9?s=100&d=identicon"><h2 id=name>Roman Gershman</h2><h3 id=title>Software Engineer</h3><span id=location><i class="fa fa-map-marker"></i>Tel Aviv</span>
<a id=follow href=https://github.com/romange>Follow</a></div><div class="article-info profile-block"><div class=article-info-block>15
<span>Posts</span></div><div class=article-info-block>17
<span>Tags</span></div></div><div class="profile-block social-links"><table><tr><td><a href=//github.com/romange target=_blank title=GitHub><i class="fa fa-github"></i></a></td><td><a href=//linkedin.com/in/romange target=_blank title=LinkedIn><i class="fa fa-linkedin"></i></a></td><td><a href=//stackoverflow.com/users/romange target=_blank title="Stack Overflow"><i class="fa fa-stack-overflow"></i></a></td><td><a href=https://romange.github.io/blog/preview/index.xml target=_blank title=RSS><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id=main><article id=page-undefined class="article article-type-page" itemscope itemprop=blogPost><div class=article-inner><img src=https://romange.github.io/blog/preview/banners/fibers.png class=article-banner><header class=article-header><a href=https://romange.github.io/blog/preview/2018/12/15/introduction-to-fibers-in-c-/><h1 class=article-title itemprop=name>Introduction to fibers in c++</h1></a><div class=article-meta><div class=article-date><i class="fa fa-calendar"></i>
<time datetime="2018-12-15 11:59:52 +0300 +0300" itemprop=datePublished>Dec 15nd 2018</time>
&#183;
1369
words
&#183;
7
minute read</div><div class=article-category><i class="fa fa-tags"></i>
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/c++>c++</a>
&#183;
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/asynchronous>asynchronous</a>
&#183;
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/fibers>fibers</a>
&#183;
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/reactive>reactive</a></div></div></header><div class=article-entry itemprop=articleBody><p>In my <a href=https://romange.github.io/blog/preview/2018/07/12/seastar-asynchronous-c-framework/>post about Seastar</a> we&rsquo;ve covered continuations style
asynchronous programming. My personal opinion is that this style is hard to work with in C++.
In this post I would like to cover alternative, Fiber-based approach.
I will use <code>Boost.Fibers</code> library in all my examples.</p><p>Fibers, or <a href=https://en.wikipedia.org/wiki/Green_threads>green threads</a>, or <em>cooperative threads</em> are similar to regular threads but with few important distinctions:</p><ol><li><p>Fibers can not move between system threads and they are usually pinned to a specific thread.</p></li><li><p>Fibers scheduler does not perform implicit contexts-switches: a fiber must explicitly give up
its control over its active execution and only one fiber can be active (running) in the thread at the same time.
The switch is performed by changing the active context and the stack to another fiber.
The old-stack is preserved until the old fiber resumes its execution. As a result,
we may write asynchronous, unprotected but safe code as long as our data access is single threaded.</p></li><li><p>The main difference between fibers and coroutines is that fibers require a scheduler which decides which active fiber is called next according to a scheduling policy. Coroutines, on the other hand, are simpler - they pass the execution to a specified point in code.</p></li><li><p>Fibers are user-land creatures, their creation or context switches betwen them does not involve kernel,
and thus they are more efficient than threads (by factor of 100).</p></li><li><p>Standard thread-blocking calls will block fibers and, in fact, will cancel any possible advantages of fibers.</p></li></ol><h3 id=accessing-data-from-multiple-fibers>Accessing data from multiple fibers.</h3><p>The snippet below demonstrates point (2) above.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>int</span> shared_state <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>auto</span> cb <span style=color:#f92672>=</span> [<span style=color:#f92672>&amp;</span>] { shared_state <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb1</span>(cb);
</span></span><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb2</span>(cb);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Possible CPU computations in the middle. Could change shared_state as well.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// ....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  fb1.join();
</span></span><span style=display:flex><span>  fb2.join();</span></span></code></pre></td></tr></table></div></div><p>Both fibers read-modify-write the same unprotected variable. The fiber scheduler might switch
the execution from the main fiber to <code>fb1</code> or <code>fb2</code> either during fiber creation or during the <code>join()</code> calls.
In this case, I explicitly launched both fibers without switching the execution,
i.e. the main fiber continued running passed constructors until <code>fb1.join()</code> call.
During <code>fb1.join()</code> call the main fiber suspends itself until <code>fb1</code> finishes running.
However, it&rsquo;s not guaranteed which fiber will run next: <code>fb1</code> or <code>fb2</code> -
this depends on the scheduler policy. In any case, each one of spawned fibers will run in
turns until the completion because they do not have any &ldquo;interrupt&rdquo; points inside their run functions.
As a result, <code>shared_state</code> will be changed sequentially.
We did not show what is the scheduler policy in this example, therefore
the order of the applied changes to <code>shared_state</code> is unknown here.</p><h3 id=calling-thread-blocking-functions-is-bad-for-fibers>Calling thread blocking functions is bad for fibers</h3><p>This snippet demonstrates point(5) above.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb1</span>([] { sleep(<span style=color:#ae81ff>1</span>); });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb2</span>([] {
</span></span><span style=display:flex><span>    this_fiber<span style=color:#f92672>::</span>yield();
</span></span><span style=display:flex><span>    do_something_in_background();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fb1.join();
</span></span><span style=display:flex><span>  fb2.join();</span></span></code></pre></td></tr></table></div></div><p>Here we start 2 fibers and make sure that <code>fb1</code> will progress first by yielding (switching) the execution from <code>fb2</code>.
Once <code>fb1</code> starts running it makes a direct system call to <code>sleep()</code>. Sleep is OS function
that is not aware of our fibers - they are user-land.
Therefore the whole thread will stall for 1 second and only when <code>fb1</code> finishes, it ill resume with <code>fb2</code>.</p><p>The same true with regular synchronization primitives:<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> state <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>mutex mu;
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>conditional_variable cv;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb1</span>([<span style=color:#f92672>&amp;</span>] {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>unique_lock<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>mutex<span style=color:#f92672>&gt;</span> lock(mu);
</span></span><span style=display:flex><span>    cv.wait(lock, [<span style=color:#f92672>&amp;</span>] { <span style=color:#66d9ef>return</span> state; });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fiber <span style=color:#a6e22e>fb2</span>([] {
</span></span><span style=display:flex><span>    this_fiber<span style=color:#f92672>::</span>yield();
</span></span><span style=display:flex><span>    state <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>    cv.notify_one();
</span></span><span style=display:flex><span>    do_something_in_background();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fb1.join();
</span></span><span style=display:flex><span>  fb2.join();</span></span></code></pre></td></tr></table></div></div>Here, like in the previous example, <code>fb2</code> yields to allow <code>fb1</code> to start running first. <code>fb1</code> blocks and waits for <code>fb2</code> to signal, but since we use regular mutex and condition variables
no context switching is done ending up with a deadlock.</p><p>To coordinate between fibers we need fiber-specific mechanisms which boost.fibers provides.
We have <code>fibers::mutex</code>, <code>fibers::conditional_variable</code>, <code>fibers::future&lt;></code> and <code>fibers::promise&lt;></code>.
Also, we have (fiber) mpmc blocking queue <code>fibers::buffered_channel</code>, which is similar to golang&rsquo;s channels.
Those constructs recognize when a fiber is stalled and call fiber scheduler to resume with the next active fiber.
This enables asynchronous execution which does not block the running thread until no active fibers are left and the system is blocked on I/O or some other signal. That means we must use fiber-cooperative code every time we use I/O or call an asynchronous event.</p><h2 id=seastar-comparison>Seastar comparison</h2><p>If you remember we reviewed Seastar&rsquo;s <code>keep_doing</code> method of repeating futurized action in the loop. With fibers it becomes much simpler and familiar:<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> keep_going <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> iteration <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>fibers<span style=color:#f92672>::</span>mutex mu;
</span></span><span style=display:flex><span>fibers<span style=color:#f92672>::</span>conditional_variable cv;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> cb <span style=color:#f92672>=</span> [<span style=color:#f92672>&amp;</span>] {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (keep_going) {
</span></span><span style=display:flex><span>    do_something_fiber_blocking();
</span></span><span style=display:flex><span>    <span style=color:#f92672>++</span>iteration;
</span></span><span style=display:flex><span>    cv.notify_on();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fiber <span style=color:#a6e22e>fb1</span>(cb);
</span></span><span style=display:flex><span>fiber <span style=color:#a6e22e>fb2</span>([<span style=color:#f92672>&amp;</span>] {
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>unique_lock<span style=color:#f92672>&lt;</span>fibers<span style=color:#f92672>::</span>mutex<span style=color:#f92672>&gt;</span> lock(mu);
</span></span><span style=display:flex><span>    cv.wait(lock, [<span style=color:#f92672>&amp;</span>] { <span style=color:#66d9ef>return</span> iteration <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>;});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  keep_going <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fb1.join();
</span></span><span style=display:flex><span>fb2.join();</span></span></code></pre></td></tr></table></div></div></p><p>Our loop is just a regular loop but its asynchronous action should block the calling fiber
when it does not have the result yet. When <code>do_something_fiber_blocking</code> blocks, the execution switches to any other active fiber. It may be that <code>fb2</code> is active and did not run yet. In that case, it will run and block at <code>cv.wait</code> line.
fb1 will iterate and wake fb2 on each iteration.
But only when the condition is fulfilled <code>fb2</code> will set <code>keep_going</code> to false.
Please note that both <code>keep_going</code> and <code>iteration</code> variables are unprotected.
As you can see, writing asynchronous code with fibers is simpler as long as you leverage
fiber properties to your advantage.</p><p>Another example from the previous post: fetching the file size asynchronously using the handler object.<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>size_t <span style=color:#a6e22e>slow_size</span>(file f) {
</span></span><span style=display:flex><span>  this_fiber<span style=color:#f92672>::</span>sleep(<span style=color:#ae81ff>10</span>ms);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> f.size();
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></p><p>As in the previous post, we stall the calling fiber for <code>10ms</code> and then call IO function <code>f.size()</code>.
Unlike with Seastar, the flow is just a regular C++ flow with the distinction that the thread &ldquo;switches&rdquo;
to other execution fibers at every &ldquo;stalling&rdquo; point like &ldquo;sleep&rdquo; and &ldquo;f.size().</p><p>With <code>sleep()</code>, the framework instructs the scheduler to suspend the calling fiber
and to resume itself after 10 milliseconds.</p><p>With <code>f.size()</code>, the developer of <code>file</code> class is responsible to suspend the fiber upon the
asynchronous call to IO device that should bring that file metadata and wake the fiber back once
the call has been completed. The synchronization can be done easily using <code>fibers::mutex</code> and
<code>fibers::conditional_variable</code> constructs as long as the underlying IO interface allows completion callbacks.</p><p>The fiber-based code is simpler than futures-based code and object ownership issues are less of a hassle.
The <code>file</code> object does not go out of scope before the asynchronous operations finish because
the calling fiber preserves the call-stack like with the classic programming models.
Seastar model assumes infinite threads of executions and even when we want synchronous continuity
we must use continuations to synchronize between consecutive actions.
With Fibers model we assume synchronous flow by default, and if we want to spawn parallel executions
we need to launch new fibers. Therefore, the amount of parallelism with fibers is controlled by number
of launched fibers, while Continuations Model provides infinitely large parallelism
by building the dependency graph of futures and continuations.</p><p>I believe that even in the case of very sophisticated asynchronous processing most flows look
synchronous with just a few branches where we want to launch many asynchronous actions in parallel.
Therefore I believe that Fiber-based model is more convenient in general and in C++ especially
due to various language restrictions and lack of automatic garbage collection.</p><p>It&rsquo;s not totally fair to compare <code>boost.fibers</code> to <a href=https://romange.github.io/blog/preview/2018/07/12/seastar-asynchronous-c-framework/>Seastar</a> because Seastar provides high level framework for asynchronous execution as well as RPC, HTTP, networking and events interfaces under the same hood.
<code>Boost.Fibers</code> on other hand is low-level library focused only on Fibers.
<code>Boost.Asio</code> and <code>Boost.Fibers</code> can provide somewhat similar functinality to Seastar.
Unfortunately there is not much material in the internet on how to use efficiently those libraries together.
That&rsquo;s why I released <a href=https://github.com/romange/gaia>GAIA</a> framework that provides high level
mechanisms to build high-performance backends. I will continue talking about GAIA in my next posts.</p></div><footer class=article-footer><a data-url=https://romange.github.io/blog/preview/2018/12/15/introduction-to-fibers-in-c-/ data-id=de0d26847baf8ad3b62477f37972b02c class=article-share-link><i class="fa fa-share"></i>
Share</a>
<a href=https://romange.github.io/blog/preview/2018/12/15/introduction-to-fibers-in-c-/#disqus_thread class=article-comment-link>Comments</a>
<script>(function(e){if(typeof __SHARE_BUTTON_BINDED__=="undefined"||!__SHARE_BUTTON_BINDED__)__SHARE_BUTTON_BINDED__=!0;else return;e("body").on("click",function(){e(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var n,c,o=e(this),a=o.attr("data-url"),s=encodeURIComponent(a),i="article-share-box-"+o.attr("data-id"),r=o.offset();if(e("#"+i).length){if(n=e("#"+i),n.hasClass("on")){n.removeClass("on");return}}else c=['<div id="'+i+'" class="article-share-box">','<input class="article-share-input" value="'+a+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+s+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+s+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+s+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+s+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join(""),n=e(c),e("body").append(n);e(".article-share-box.on").hide(),n.css({top:r.top+25,left:r.left}).addClass("on")}).on("click",".article-share-box",function(e){e.stopPropagation()}).on("click",".article-share-box-input",function(){e(this).select()}).on("click",".article-share-box-link",function(e){e.preventDefault(),e.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")})})(jQuery)</script></footer></div><nav id=article-nav><a href=https://romange.github.io/blog/preview/2018/07/12/seastar-asynchronous-c-framework/ id=article-nav-older class=article-nav-link-wrap><strong class=article-nav-caption>Older</strong><div class=article-nav-title>Seastar - Asynchronous C++ framework</div></a><a href=https://romange.github.io/blog/preview/2019/07/15/gaia-mapreduce-tutorial-part1/ id=article-nav-newer class=article-nav-link-wrap><strong class=article-nav-caption>Newer</strong><div class=article-nav-title>Gaia Mapreduce Tutorial - part1</div></a></nav></article><section id=comments><div id=disqus_thread><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//romange.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></section><aside id=sidebar><div class=widget-wrap><h3 class=widget-title>Recents</h3><div class=widget><ul id=recent-post><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2022/10/23/balanced-vs-unbalanced/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/dragonfly.png) alt="Introduction to fibers in c++" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2022/10/23/balanced-vs-unbalanced/ class=title>balanced vs unbalanced</a></p><p class=item-date><time datetime="2022-10-23 09:24:23 +0300 +0300" itemprop=datePublished>Oct 23nd 2022</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2022/06/23/dragonfly-cache-design/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2022/06/23/dragonfly-cache-design/ class=title>Dragonfly Cache Design</a></p><p class=item-date><time datetime="2022-06-23 12:00:00 +0300 +0300" itemprop=datePublished>Jun 23nd 2022</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2022/01/30/redis-analysis-part-2-simplicity/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/simple.jpg) alt="Introduction to fibers in c++" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2022/01/30/redis-analysis-part-2-simplicity/ class=title>Redis Analysis - Part 2: Simplicity</a></p><p class=item-date><time datetime="2022-01-30 20:00:00 +0200 +0200" itemprop=datePublished>Jan 30nd 2022</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2021/12/09/redis-analysis-part-1-threading-model/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/jet.jpg) alt="Introduction to fibers in c++" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2021/12/09/redis-analysis-part-1-threading-model/ class=title>Redis Analysis - Part 1: Threading model</a></p><p class=item-date><time datetime="2021-12-09 11:00:00 +0300 +0300" itemprop=datePublished>Dec 9nd 2021</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2021/11/28/a-prelude-to-analysis-of-redis-memory-store/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/1200px-Redis_Logo.svg.png) alt="Introduction to fibers in c++" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2021/11/28/a-prelude-to-analysis-of-redis-memory-store/ class=title>A prelude to analysis of Redis memory-store</a></p><p class=item-date><time datetime="2021-11-28 17:46:19 +0300 +0300" itemprop=datePublished>Nov 28nd 2021</time></p></div></li></ul></div></div><div class=widget-wrap><h3 class=widget-title>Tags</h3><div class=widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/asynchronous>asynchronous</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/backend>backend</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/blogging>blogging</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/c++>c++</a>
<span class=category-list-count>8</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/code-generation>code-generation</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/concurrency>concurrency</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/dragonfly>dragonfly</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/fibers>fibers</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/gaia>gaia</a>
<span class=category-list-count>3</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/io_uring>io_uring</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/linux>linux</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/mapreduce>mapreduce</a>
<span class=category-list-count>3</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/posix>posix</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/programming>programming</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/reactive>reactive</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/redis>redis</a>
<span class=category-list-count>4</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/seastar>seastar</a>
<span class=category-list-count>1</span></li></ul></div></div><div class=widget-wrap><h3 class=widget-title>Tag cloud</h3><div class="widget tagcloud"><a href=https://romange.github.io/blog/preview/tags/asynchronous style=font-size:12px>asynchronous</a>
<a href=https://romange.github.io/blog/preview/tags/backend style=font-size:12px>backend</a>
<a href=https://romange.github.io/blog/preview/tags/blogging style=font-size:12px>blogging</a>
<a href=https://romange.github.io/blog/preview/tags/c++ style=font-size:12px>c++</a>
<a href=https://romange.github.io/blog/preview/tags/code-generation style=font-size:12px>code-generation</a>
<a href=https://romange.github.io/blog/preview/tags/concurrency style=font-size:12px>concurrency</a>
<a href=https://romange.github.io/blog/preview/tags/dragonfly style=font-size:12px>dragonfly</a>
<a href=https://romange.github.io/blog/preview/tags/fibers style=font-size:12px>fibers</a>
<a href=https://romange.github.io/blog/preview/tags/gaia style=font-size:12px>gaia</a>
<a href=https://romange.github.io/blog/preview/tags/io_uring style=font-size:12px>io_uring</a>
<a href=https://romange.github.io/blog/preview/tags/linux style=font-size:12px>linux</a>
<a href=https://romange.github.io/blog/preview/tags/mapreduce style=font-size:12px>mapreduce</a>
<a href=https://romange.github.io/blog/preview/tags/posix style=font-size:12px>posix</a>
<a href=https://romange.github.io/blog/preview/tags/programming style=font-size:12px>programming</a>
<a href=https://romange.github.io/blog/preview/tags/reactive style=font-size:12px>reactive</a>
<a href=https://romange.github.io/blog/preview/tags/redis style=font-size:12px>redis</a>
<a href=https://romange.github.io/blog/preview/tags/seastar style=font-size:12px>seastar</a></div></div><div id=toTop class="fa fa-angle-up"></div></aside></div></div><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2022
Roman Gershman</div></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-107146718-1","auto"),ga("send","pageview"))</script><script src=https://romange.github.io/blog/preview/fancybox/jquery.fancybox.pack.js></script>
<script src=https://romange.github.io/blog/preview/js/script.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>