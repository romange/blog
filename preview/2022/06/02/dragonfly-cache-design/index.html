<!doctype html><html lang=en-us><head><title>Dragonfly Cache Design &#183; These are the wrong sort of bees</title><meta name=generator content="Hugo 0.100.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=author content="Roman Gershman"><meta name=description content="The wrong sort of bees"><link rel=canonical href=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/><link rel=icon href=https://romange.github.io/blog/preview/favicon.ico><link rel=apple-touch-icon href=https://romange.github.io/blog/preview/apple-touch-icon.png><link rel=stylesheet href=https://romange.github.io/blog/preview/css/style.css><link rel=stylesheet href=https://romange.github.io/blog/preview/css/font-awesome.min.css><link rel=stylesheet href=https://romange.github.io/blog/preview/css/monokai.css><link rel=stylesheet href=https://romange.github.io/blog/preview/fancybox/jquery.fancybox.css><link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel=stylesheet type=text/css><link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel=stylesheet type=text/css><meta property="og:title" content="Dragonfly Cache Design"><meta property="og:description" content="I talked in my previous post about Redis eviction policies.
In this post, I would like to describe the design behind Dragonfly cache."><meta property="og:type" content="article"><meta property="og:url" content="https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-06-02T09:53:03+03:00"><meta property="article:modified_time" content="2022-06-02T09:53:03+03:00"><meta itemprop=name content="Dragonfly Cache Design"><meta itemprop=description content="I talked in my previous post about Redis eviction policies.
In this post, I would like to describe the design behind Dragonfly cache."><meta itemprop=datePublished content="2022-06-02T09:53:03+03:00"><meta itemprop=dateModified content="2022-06-02T09:53:03+03:00"><meta itemprop=wordCount content="918"><meta itemprop=keywords content="dragonfly,redis,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dragonfly Cache Design"><meta name=twitter:description content="I talked in my previous post about Redis eviction policies.
In this post, I would like to describe the design behind Dragonfly cache."><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js></script></head><body><div class=container><div id=container><header id=header><div id=header-main class=header-inner><div class=outer><a href=https://romange.github.io/blog/preview/ id=logo><i class=logo style=background-image:url(https://romange.github.io/blog/preview/css/images/7.png)></i>
<span class=site-title>These are the wrong sort of bees</span></a><nav id=main-nav><a class=main-nav-link href=https://romange.github.io/blog/preview/tags/>Tags</a>
<a class=main-nav-link href=https://romange.github.io/blog/preview/about/>About</a></nav><nav id=sub-nav><div class=profile id=profile-nav><a id=profile-anchor href=javascript:;><img class=avatar src=https://romange.github.io/blog/preview/css/images/avatar.png><i class="fa fa-caret-down"></i></a></div></nav><div id=search-form-wrap><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder=Search>
<button type=submit class=search-form-submit></button>
<input type=hidden name=sitesearch value=https://romange.github.io/blog/preview/></form></div></div></div><div id=main-nav-mobile class="header-sub header-inner"><table class="menu outer"><tbody><tr><td><a class=main-nav-link href=https://romange.github.io/blog/preview/tags/>Tags</a></td><td><a class=main-nav-link href=https://romange.github.io/blog/preview/about/>About</a></td><td><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder=Search>
<input type=hidden name=sitesearch value=https://romange.github.io/blog/preview/></form></td></tr></tbody></table></div></header><div class=outer><aside id=profile><div class="inner profile-inner"><div class="base-info profile-block"><img id=avatar src="https://www.gravatar.com/avatar/4a203a48eb1cdb1b8c47d008f0c139c9?s=100&d=identicon"><h2 id=name>Roman Gershman</h2><h3 id=title>Software Engineer</h3><span id=location><i class="fa fa-map-marker"></i>Tel Aviv</span>
<a id=follow href=https://github.com/romange>Follow</a></div><div class="article-info profile-block"><div class=article-info-block>14
<span>Posts</span></div><div class=article-info-block>17
<span>Tags</span></div></div><div class="profile-block social-links"><table><tr><td><a href=//github.com/romange target=_blank title=GitHub><i class="fa fa-github"></i></a></td><td><a href=//linkedin.com/in/romange target=_blank title=LinkedIn><i class="fa fa-linkedin"></i></a></td><td><a href=//stackoverflow.com/users/romange target=_blank title="Stack Overflow"><i class="fa fa-stack-overflow"></i></a></td><td><a href=https://romange.github.io/blog/preview/index.xml target=_blank title=RSS><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id=main><article id=page-undefined class="article article-type-page" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><a href=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/><h1 class=article-title itemprop=name>Dragonfly Cache Design</h1></a><div class=article-meta><div class=article-date><i class="fa fa-calendar"></i>
<time datetime="2022-06-02 09:53:03 +0300 +0300" itemprop=datePublished>Jun 2nd 2022</time>
&#183;
918
words
&#183;
5
minute read</div><div class=article-category><i class="fa fa-tags"></i>
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/dragonfly>dragonfly</a>
&#183;
<a class=article-category-link href=https://romange.github.io/blog/preview/tags/redis>redis</a></div></div></header><div class=article-entry itemprop=articleBody><p>I talked in my <a href=simple_is_beatiful.md>previous post</a> about Redis eviction policies.
In this post, I would like to describe the design behind Dragonfly cache.</p><p>If you have not heard about <a href=https://github.com/dragonflydb/dragonfly>Dragonfly</a> - please check it out. It uses - what I hope - novel and interesting ideas backed up by the research from recent years<a href=https://doi.org/10.1007/s00778-014-0377-7>1</a>
and <a href=https://arxiv.org/abs/2003.07302>2</a>. It&rsquo;s meant to fix many problems that exist with in-memory datastores today. I have been working on Dragonfly for the last 7 months. It has been one of the more interesting, fulfilling, and challenging projects I&rsquo;ve ever done and I do not mean to stop working on it any time soon :)</p><p>Anyway, back to cache design. Let&rsquo;s start with a short overview of what LRU cache is and what Redis does. We will see what are the shortcomings of LRU cache in general, and of Redis implementation specifically.</p><h2 id=lru>LRU</h2><p>The LRU (least recently used) cache policy evicts items that were least recently used. Why?
A cache algorithm strives to optimize a single metric - the hit ratio, or the probability that its items will be accessed in the future.</p><p>If a cache is full, it needs to vacate items to make room for new additions. It&rsquo;s reasonable to assume that an item accessed a long time ago, won&rsquo;t be used in the future and is the least valuable to keep. The cache frees space for new additions by removing the least valuable items. <strong>Assuming</strong> that <em>least recently used</em> items are <em>least valuable</em>, this algorithm will behave optimally. The LRU algorithm is very old, probably older than me, and has been used as a disk cache in first computers.</p><p>Unfortunately, this algorithm behaves poorly if the assumption above does not hold. Consider, for example, any access pattern with <a href=https://en.wikipedia.org/wiki/Long_tail>Long tail distribution</a>.</p><figure><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Long_tail.svg/1920px-Long_tail.svg.png alt="long tail distribution" width=350px></figure><p>In this case, lots of newly added &ldquo;yellow&rdquo; items with low access frequency could push out rare &ldquo;green&rdquo; items responsible for the vast majority of hits. Memory caches usually hold just a few percent of all the possible data. Therefore the LRU policy may drop its contents together with valuable &ldquo;green&rdquo; entities due to traffic fluctuations, just because they are least recently used compared to newly added &ldquo;yellow&rdquo; items.</p><figure><img src=/img/lru.svg></figure><h4 id=lru-efficiency>LRU efficiency</h4><p>LRU is considered a simple algorithm that can be implemented efficiently.
Indeed, we just need to maintain all the items in a double-linked list. When an item is accessed, we just move it to the head of the list. To vacate LRU items, we pop from the tail of the list. See the diagram above. All operations are done in O(1), and the memory overhead per item is 2 pointers, i.e. 16 bytes on 64bit architecture.</p><h2 id=lru-in-redis>LRU in Redis</h2><p>Redis implements a few eviction policy heuristics. Some of them are described as &ldquo;approximated LRU&rdquo;. Why aproximated? Because Redis does not maintain an explicit global order among its items. Instead, it stores the last access timestamp in each entry.</p><p>Upon eviction attempt, Redis samples K entries and chooses to vacate an item with the oldest timestamp. This way Redis saves 16 bytes per entry needed for ordering items in one global order. This heuristic is very rough approximation to an LRU which by itself have weaknesses, as we saw before. Redis maintainers <a href=https://github.com/redis/redis/issues/8947>have recently discussed</a> an option to add additional heuristic to Redis by implementing a classic LRU policy with global order but decided against it.</p><h2 id=dragonfly-cache>Dragonfly Cache</h2><p>Dragonfly implements cache that a) unlike LRU is resistent to fluctuations of recent traffic, b) does not require random sampling or other approximations like in Redis, c) has no memory overhead per item, not pointers and not a timestamp. Afaik, it&rsquo;s a novel approach for cache design that has not been suggested before.</p><p><em>I want to thank Ben Manes, the author of wonderful <a href=https://github.com/ben-manes/caffeine>caffeine package</a> for early comments and the guidance on how to use caffeine simulator in order to compare Dragonfly Cache to other caches.</em></p><p>Dragonfly Cache is based on another famous cache policy from <a href=https://api.semanticscholar.org/CorpusID:6259428>1994 paper</a> called &ldquo;2Q: A Low Overhead High Performance Buffer Management Replacement Algorithm&rdquo;.</p><p>2Q addresses the issues with LRU by introducing two independent buffers. Instead of considering just recency as a factor, 2Q also considers access frequency for each item. It first admits recent items into so called probationary buffer (see below). This buffer holds only little part of the whole cache space, say less than 10%. All newly added items compete with each other inside this buffer.</p><figure><img src=/img/2q-cache.svg></figure><p>Only if a probationary item was accessed at least once it is upgraded to the protected buffer. By doing so, it evicts the least recently used item from the protected buffer back to probabtionary buffer. I found <a href=https://arpitbhayani.me/blogs/2q-cache>this post</a> that explains in more detail about 2Q.</p><p>2Q improves LRU in the following sense: just because a new item was added to the cache, does not mean it&rsquo;s useful. Instead, only if was fetched from cache at least once, it&rsquo;s considered to be a high-quality item and it&rsquo;s upgraded to the protected buffer.</p><p>It has been shown empirically that 2Q cache is more robust and achives a higher hit-rate than its LRU counterpart.</p><p>Ok, so a naive solution could be - to divide Dragonfly entries into two buffers and use a fifo ordering for a probationary buffer and a LRU linked-list for the protected buffer.
Obviosly, it would require using additional metadata and waste precious memory.</p><p>Instead, Dragonfly leverages the unique design of <a href=https://github.com/dragonflydb/dragonfly/blob/main/doc/dashtable.md>Dashtable</a> and uses its weak ordering characteristics for its advantage.</p><p>This is how Dashtable segment looks like.</p></div><footer class=article-footer><a data-url=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/ data-id=a8bffb70658cb0a33e1f20d4798ad614 class=article-share-link><i class="fa fa-share"></i>
Share</a>
<a href=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/#disqus_thread class=article-comment-link>Comments</a>
<script>(function(e){if(typeof __SHARE_BUTTON_BINDED__=='undefined'||!__SHARE_BUTTON_BINDED__)__SHARE_BUTTON_BINDED__=!0;else return;e('body').on('click',function(){e('.article-share-box.on').removeClass('on')}).on('click','.article-share-link',function(c){c.stopPropagation();var t,r,s=e(this),i=s.attr('data-url'),n=encodeURIComponent(i),o='article-share-box-'+s.attr('data-id'),a=s.offset();if(e('#'+o).length){if(t=e('#'+o),t.hasClass('on')){t.removeClass('on');return}}else r=['<div id="'+o+'" class="article-share-box">','<input class="article-share-input" value="'+i+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+n+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+n+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+n+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+n+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>','</div>','</div>'].join(''),t=e(r),e('body').append(t);e('.article-share-box.on').hide(),t.css({top:a.top+25,left:a.left}).addClass('on')}).on('click','.article-share-box',function(e){e.stopPropagation()}).on('click','.article-share-box-input',function(){e(this).select()}).on('click','.article-share-box-link',function(e){e.preventDefault(),e.stopPropagation(),window.open(this.href,'article-share-box-window-'+Date.now(),'width=500,height=450')})})(jQuery)</script></footer></div><nav id=article-nav><a href=https://romange.github.io/blog/preview/2022/01/30/redis-analysis-part-2-simplicity/ id=article-nav-older class=article-nav-link-wrap><strong class=article-nav-caption>Older</strong><div class=article-nav-title>Redis Analysis - Part 2: Simplicity</div></a></nav></article><section id=comments><div id=disqus_thread><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//romange.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></section><aside id=sidebar><div class=widget-wrap><h3 class=widget-title>Recents</h3><div class=widget><ul id=recent-post><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2022/06/02/dragonfly-cache-design/ class=title>Dragonfly Cache Design</a></p><p class=item-date><time datetime="2022-06-02 09:53:03 +0300 +0300" itemprop=datePublished>Jun 2nd 2022</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2022/01/30/redis-analysis-part-2-simplicity/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/simple.jpg) alt="Dragonfly Cache Design" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2022/01/30/redis-analysis-part-2-simplicity/ class=title>Redis Analysis - Part 2: Simplicity</a></p><p class=item-date><time datetime="2022-01-30 20:00:00 +0200 +0200" itemprop=datePublished>Jan 30nd 2022</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2021/12/09/redis-analysis-part-1-threading-model/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/jet.jpg) alt="Dragonfly Cache Design" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2021/12/09/redis-analysis-part-1-threading-model/ class=title>Redis Analysis - Part 1: Threading model</a></p><p class=item-date><time datetime="2021-12-09 11:00:00 +0300 +0300" itemprop=datePublished>Dec 9nd 2021</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2021/11/28/a-prelude-to-analysis-of-redis-memory-store/ class=thumbnail><span style=background-image:url(https://romange.github.io/blog/preview/banners/1200px-Redis_Logo.svg.png) alt="Dragonfly Cache Design" class=thumbnail-image></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2021/11/28/a-prelude-to-analysis-of-redis-memory-store/ class=title>A prelude to analysis of Redis memory-store</a></p><p class=item-date><time datetime="2021-11-28 17:46:19 +0300 +0300" itemprop=datePublished>Nov 28nd 2021</time></p></div></li><li><div class=item-thumbnail><a href=https://romange.github.io/blog/preview/2020/09/05/io_uring-powered-event-loop-with-efficient-message-passing/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://romange.github.io/blog/preview/2020/09/05/io_uring-powered-event-loop-with-efficient-message-passing/ class=title>IO_URING powered event-loop with efficient message passing</a></p><p class=item-date><time datetime="2020-09-05 20:30:11 +0300 +0300" itemprop=datePublished>Sep 5nd 2020</time></p></div></li></ul></div></div><div class=widget-wrap><h3 class=widget-title>Tags</h3><div class=widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/asynchronous>asynchronous</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/backend>backend</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/blogging>blogging</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/c++>c++</a>
<span class=category-list-count>8</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/code-generation>code-generation</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/concurrency>concurrency</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/dragonfly>dragonfly</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/fibers>fibers</a>
<span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/gaia>gaia</a>
<span class=category-list-count>3</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/io_uring>io_uring</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/linux>linux</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/mapreduce>mapreduce</a>
<span class=category-list-count>3</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/posix>posix</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/programming>programming</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/reactive>reactive</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/redis>redis</a>
<span class=category-list-count>4</span></li><li class=category-list-item><a class=category-list-link href=https://romange.github.io/blog/preview/tags/seastar>seastar</a>
<span class=category-list-count>1</span></li></ul></div></div><div class=widget-wrap><h3 class=widget-title>Tag cloud</h3><div class="widget tagcloud"><a href=https://romange.github.io/blog/preview/tags/asynchronous style=font-size:12px>asynchronous</a>
<a href=https://romange.github.io/blog/preview/tags/backend style=font-size:12px>backend</a>
<a href=https://romange.github.io/blog/preview/tags/blogging style=font-size:12px>blogging</a>
<a href=https://romange.github.io/blog/preview/tags/c++ style=font-size:12px>c++</a>
<a href=https://romange.github.io/blog/preview/tags/code-generation style=font-size:12px>code-generation</a>
<a href=https://romange.github.io/blog/preview/tags/concurrency style=font-size:12px>concurrency</a>
<a href=https://romange.github.io/blog/preview/tags/dragonfly style=font-size:12px>dragonfly</a>
<a href=https://romange.github.io/blog/preview/tags/fibers style=font-size:12px>fibers</a>
<a href=https://romange.github.io/blog/preview/tags/gaia style=font-size:12px>gaia</a>
<a href=https://romange.github.io/blog/preview/tags/io_uring style=font-size:12px>io_uring</a>
<a href=https://romange.github.io/blog/preview/tags/linux style=font-size:12px>linux</a>
<a href=https://romange.github.io/blog/preview/tags/mapreduce style=font-size:12px>mapreduce</a>
<a href=https://romange.github.io/blog/preview/tags/posix style=font-size:12px>posix</a>
<a href=https://romange.github.io/blog/preview/tags/programming style=font-size:12px>programming</a>
<a href=https://romange.github.io/blog/preview/tags/reactive style=font-size:12px>reactive</a>
<a href=https://romange.github.io/blog/preview/tags/redis style=font-size:12px>redis</a>
<a href=https://romange.github.io/blog/preview/tags/seastar style=font-size:12px>seastar</a></div></div><div id=toTop class="fa fa-angle-up"></div></aside></div></div><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2022
Roman Gershman</div></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-107146718-1','auto'),ga('send','pageview'))</script><script src=https://romange.github.io/blog/preview/fancybox/jquery.fancybox.pack.js></script>
<script src=https://romange.github.io/blog/preview/js/script.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>